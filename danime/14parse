#!/bin/bash
# shellcheck disable=SC2086,SC1091,SC1090,SC2154
((def_parse)) && return 0 || def_parse=1
. libbash
. spinner
. 01include
DEBUG=${DEBUG:-false}
#start:code
SUPPORTED_HOSTS='trollvid|mp4.sh|mp4upload|vidstreaming|xstreamcdn|gogo server|mixdrop'
get_effective_url()
{
	xargs curl --disable -ILksXGET -o /dev/null -w '%{url_effective}\n' 2> /dev/null | grep '^http'
}
get_url()
{
	local ep_file_host ep_file_id n try=0 url
	ep_file_host=$(echo "$1" | jq -r '.host')
	ep_file_id=$(echo "$1" | jq -r '.id' | xargs basename -a)
	mirror="${ep_file_host//[^[:alnum:]]/}"
	if ! {
		echo "$SUPPORTED_HOSTS" | grep -q "$ep_file_host"
	}; then
		echo "unimplemented:$ep_file_host"
		return 1
	fi
	for n in $ep_file_id; do
		if [[ $(type -t "${mirror}:get_url" || type -w "${mirror}:get_url") ]]; then
			url=""
			try=0
			while [[ -z $url ]] && ((try++ < 5)); do
				((try > 1)) && sleep 2
				url="$("${mirror}:get_url" "${n}" "$2")"
			done
			echo "$url"
		else
			echo "unimplemented:${ep_file_host/_/.}"
			break
		fi
	done
}
beautify_js()
{
	js-beautify -xn -e \\n -k --brace-style=expand - 2> /dev/null
}

mp4upload:get_url()
{
	curl --disable -ks "https://www.mp4upload.com/embed-$1.html" | grep 'eval(' | cut -d\> -f2- | beautify_js | sed -znE 's@.*(http(s|)://[[:alnum:]]+.mp4upload.com:[[:digit:]]+/[[:lower:]]/[[:alnum:]]+/[[:alnum:]-]+.mp4).*@\1\n@p'
}

xstreamcdn:get_url()
{
	curl --disable -sX POST "https://embedsito.com/api/source/$1" --data "r=https://1anime.to/" --data 'd=embedsito.com' | jq -r 'select(.success == true).data|[ reverse[]|select(.label == "720p" or .label == "480p")][0].file' 2> /dev/null | get_effective_url
}

mp4sh:get_url()
{
	trollvid:get_url "$@"
}

trollvid:get_url()
{
	local token xToken try=0 url page
	while [[ -z $url ]] && ((try++ < 5)); do
		((try > 1)) && sleep 2
		xToken=$(
			curl --disable -L -H "referer: https://1anime.to$(da_db get url)" "${CURL_OPTIONS[@]}" -s "${PUPPETEER_PROXY}$2" \
				| sed -nE "/xToken/s/.*'(.*)'.*/\1/p"
		)
		[ -z "$xToken" ] && continue
		[ "$xToken" ] \
			&& page=$(
				curl --disable "https://mp4.sh/embed/${1}${xToken}" \
					-s -H 'Referer: https://1anime.to/'
			)
		[ -n "$page" ] && stream=$(sed -nE "/let stream =/s/.*'(.*)'.*/\1/p" <<< "$page")
		[ -n "$stream" ] && echo "$stream" && return
		[ -n "$page" ] && token=$(sed -nE "/token: /s/.*'(.*)'.*/\1/p" <<< "$page")
		[ -z "$token" ] && continue
		[ "$token" ] \
			&& url=$(
				curl --disable "https://mp4.sh/v/$1" \
					-H "User-Agent: $USER_AGENT" \
					-H "Referer: https://mp4.sh/embed/${1}${xToken}" \
					-H "Alt-Used: mp4.sh" \
					-H 'Origin: https://mp4.sh' \
					-s --data-raw "token=$token" \
					| jq -r 'select(.success == true).file' 2> /dev/null
			)
		[ "$url" ] \
			&& curl --disable -s "$(echo "$url" | cut -d/ -f1-3)/video.php" \
				--data-raw "token=$token" 2> /dev/null \
			&& echo "$url" \
			&& break
	done
}

vidstreaming:get_url()
{
	curl --disable -s "https://gogoplay1.com/download?id=$1" \
		| xmllint \
			--nocdata --noent --html --xmlout \
			--xpath '//a[@download]/@href' - 2> /dev/null \
		| sed 's/[[:blank:]]?*href="\(.*\)"/\1/' \
		| tail -n 2 \
		| head -n 1
}

gogoserver:get_url()
{
	vidstreaming:get_url "$1"
}

mixdrop:get_url()
{
	curl --disable -s "https://mixdrop.to/e/$1" \
		| grep '^eval' \
		| beautify_js \
		| grep MDCore.wurl \
		| sed -E 's@.* = "//(.*)".*@https://\1@'
}

cloud9:get_url()
{
	curl --disable -s "https://api.cloud9.to/stream/$1" \
		| jq -r 'select(.success == true).data.sources|[.[]|select(.height<=720)][0].file'
}
#end:code
if ! {
	[[ -n $ZSH_EVAL_CONTEXT && $ZSH_EVAL_CONTEXT =~ :file$ ]] || {
		[[ -n $BASH_VERSION ]] || [[ $0 =~ bin/bashdb$ ]]
	} && {
		return 0 2> /dev/null
	}
}; then
	(($# >= 2)) || exit
	remote=$1
	shift
	$remote:get_url "$@"
fi
